<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>恐怖奶奶 - 天创时代</title>
    <!-- 添加Socket.io客户端库 -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="api-config.js"></script>
    <script src="api-service.js"></script>
    <script src="data-adapter.js"></script>
    <script src="points-system.js"></script>
    <script src="user-system.js"></script>
    <script src="common.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Quicksand', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b1b 50%, #0f0f0f 100%);
            min-height: 100vh;
            color: white;
            position: relative;
            overflow-x: hidden;
        }
        
        /* 恐怖背景效果 - 升级版 */
        .horror-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(139, 0, 0, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(75, 0, 130, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 0, 0, 0.2) 0%, transparent 50%);
            animation: horrorPulse 4s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        /* 奶奶反射效果 */
        .grandma-reflection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200"><path d="M100,20 C60,20 30,50 30,90 C30,130 60,160 100,160 C140,160 170,130 170,90 C170,50 140,20 100,20 Z" fill="none" stroke="rgba(139,0,0,0.1)" stroke-width="2"/></svg>') repeat;
            opacity: 0.1;
            pointer-events: none;
            z-index: 1;
            animation: reflectionMove 20s linear infinite;
        }
        
        @keyframes reflectionMove {
            0% { transform: translateX(0) translateY(0); }
            50% { transform: translateX(-10px) translateY(-5px); }
            100% { transform: translateX(0) translateY(0); }
        }
        
        /* 天气效果 - 血雨 */
        .weather-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 1s ease;
        }
        
        .weather-effect.blood-rain {
            background: 
                radial-gradient(circle at 10% 20%, rgba(139, 0, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 30% 40%, rgba(139, 0, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 50% 60%, rgba(139, 0, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 70% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 10%, rgba(139, 0, 0, 0.1) 0%, transparent 20%);
            opacity: 0.3;
            animation: bloodRain 3s linear infinite;
        }
        
        @keyframes bloodRain {
            0% { background-position: 0 0; }
            100% { background-position: 0 100px; }
        }
        
        @keyframes horrorPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        
        /* 闪电效果 */
        .lightning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0);
            pointer-events: none;
            z-index: 100;
        }
        
        .lightning.flash {
            animation: lightningFlash 0.3s ease-out;
        }
        
        @keyframes lightningFlash {
            0% { background: rgba(255, 255, 255, 0); }
            50% { background: rgba(255, 255, 255, 0.8); }
            100% { background: rgba(255, 255, 255, 0); }
        }
        
        /* 主容器 */
        .main-container {
            position: relative;
            z-index: 10;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 顶部导航 */
        .top-nav {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 0, 0, 0.3);
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8b0000, #4b0082);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            animation: logo-bounce 2s ease-in-out infinite;
        }
        
        @keyframes logo-bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
            60% { transform: translateY(-4px); }
        }
        
        .logo-text {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(45deg, #ff0000, #8b0000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: linear-gradient(135deg, #8b0000, #4b0082);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .nav-btn:hover::before {
            left: 100%;
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 0, 0, 0.4);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8b0000, #4b0082);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: bold;
            color: #fff;
            font-size: 1rem;
        }
        
        .user-points {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 4px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .user-canes {
            background: linear-gradient(135deg, #8b4513, #a0522d);
            color: white;
            padding: 4px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-left: 8px;
        }
        
        /* 游戏统计栏 */
        .game-stats {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .stat-card {
            background: rgba(255, 0, 0, 0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 0, 0, 0.2);
        }
        
        .stat-label {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #fff;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        /* 主游戏区域 */
        .game-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .game-area {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            border: 1px solid rgba(255, 0, 0, 0.3);
            position: relative;
        }
        
        .game-title {
            font-size: 2rem;
            color: #ff0000;
            margin-bottom: 25px;
            text-align: center;
            font-weight: bold;
            text-shadow: 0 3px 6px rgba(255, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            animation: titleGlow 2s ease-in-out infinite;
        }
        
        @keyframes titleGlow {
            0%, 100% { text-shadow: 0 3px 6px rgba(255, 0, 0, 0.5); }
            50% { text-shadow: 0 3px 15px rgba(255, 0, 0, 0.8); }
        }
        
        .grandma-icon {
            font-size: 1.5rem;
            animation: grandmaFloat 3s ease-in-out infinite;
        }
        
        @keyframes grandmaFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(-5deg); }
            75% { transform: translateY(-10px) rotate(5deg); }
        }
        
        /* 游戏计时器 */
        .game-timer {
            background: rgba(139, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid rgba(255, 0, 0, 0.3);
            position: relative;
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: #ff6b35;
            text-shadow: 0 3px 6px rgba(0,0,0,0.5);
            font-family: 'Courier New', monospace;
        }
        
        .timer-display.warning {
            color: #ff0000;
            animation: timerWarning 1s ease-in-out infinite;
        }
        
        @keyframes timerWarning {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .timer-status {
            color: #ff6b6b;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        /* 房间网格 */
        .rooms-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .room {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .room::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.5) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .room:hover::before {
            opacity: 1;
        }
        
        .room:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 0, 0, 0.3);
            border-color: rgba(255, 0, 0, 0.6);
        }
        
        .room.selected {
            background: rgba(0, 100, 0, 0.3);
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        
        .room.danger {
            background: rgba(139, 0, 0, 0.5);
            border-color: #ff0000;
            animation: dangerPulse 1s ease-in-out infinite;
        }
        
        @keyframes dangerPulse {
            0%, 100% { 
                background: rgba(139, 0, 0, 0.5);
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            }
            50% { 
                background: rgba(255, 0, 0, 0.7);
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            }
        }
        
        .room.safe {
            background: rgba(0, 100, 0, 0.3);
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }
        
        .room-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            transition: transform 0.3s ease;
        }
        
        .room:hover .room-icon {
            transform: scale(1.2);
        }
        
        .room-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .room-pool {
            color: #ff6b35;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .room-players {
            color: #3498db;
            font-size: 0.85em;
        }
        
        .room-bet {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 107, 53, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        /* 投注区域 */
        .betting-area {
            background: rgba(139, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .betting-title {
            color: #ff6b6b;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .bet-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .bet-input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 0, 0, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1rem;
            width: 150px;
            text-align: center;
        }
        
        .bet-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .bet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
        }
        
        .bet-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .quick-bet-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .quick-bet {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid rgba(255, 107, 53, 0.5);
            color: #ff6b35;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .quick-bet:hover {
            background: rgba(255, 107, 53, 0.4);
            transform: translateY(-1px);
        }
        
        /* 侧边栏 */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        /* 奖金池 */
        .prize-pool {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            border: 2px solid rgba(255, 215, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .prize-pool::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            animation: rotate-glow 20s linear infinite;
        }
        
        @keyframes rotate-glow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .prize-pool-title {
            font-size: 1.3rem;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }
        
        .prize-amount {
            font-size: 2rem;
            color: #ffd700;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 3px 6px rgba(255, 215, 0, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .prize-info {
            color: #ff6b6b;
            font-size: 0.9rem;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        /* 连胜显示 */
        .win-streak {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.4);
            z-index: 100;
            animation: streakGlow 2s ease-in-out infinite;
        }
        
        @keyframes streakGlow {
            0%, 100% { box-shadow: 0 10px 25px rgba(255, 107, 53, 0.4); }
            50% { box-shadow: 0 15px 35px rgba(255, 107, 53, 0.6); }
        }
        
        .streak-text {
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .streak-number {
            color: #ffd700;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        /* 历史记录 */
        .history-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .history-title {
            font-size: 1.3rem;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-round {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            margin-right: 15px;
            font-size: 0.8rem;
        }
        
        .history-rooms {
            flex: 1;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .history-mode {
            color: #ffd700;
            font-weight: bold;
            font-size: 0.8rem;
            margin-top: 3px;
        }
        
        /* 排行榜 */
        .leaderboard {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.8);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .leaderboard-title {
            font-size: 1.3rem;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .leaderboard-tab {
            flex: 1;
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid rgba(255, 107, 53, 0.5);
            color: #ff6b35;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .leaderboard-tab.active {
            background: rgba(255, 107, 53, 0.5);
            color: white;
        }
        
        .leaderboard-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .leaderboard-rank {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #8b0000;
            margin-right: 15px;
        }
        
        .leaderboard-rank.silver {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #333;
        }
        
        .leaderboard-rank.bronze {
            background: linear-gradient(135deg, #cd7f32, #e4a853);
            color: white;
        }
        
        .leaderboard-name {
            flex: 1;
            color: white;
            font-weight: 600;
        }
        
        .leaderboard-value {
            color: #ffd700;
            font-weight: bold;
        }
        
        /* 多人游戏房间样式 */
        .multiplayer-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .multiplayer-title {
            font-size: 1.5rem;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .multiplayer-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .multiplayer-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .multiplayer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.4);
        }
        
        .multiplayer-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .multiplayer-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .multiplayer-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .rooms-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .room-item {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .room-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .room-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .room-item-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }
        
        .room-item-status {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .room-item-status.waiting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        
        .room-item-status.playing {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .room-item-status.finished {
            background: rgba(40, 167, 69, 0.2);
            color: #27ae60;
        }
        
        .room-item-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .room-item-info-label {
            color: #ff6b6b;
            font-size: 0.9rem;
        }
        
        .room-item-info-value {
            color: white;
            font-weight: 600;
        }
        
        .room-item-players {
            margin-bottom: 10px;
        }
        
        .room-item-player {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .room-item-player-host {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .room-item-player-name {
            color: white;
            font-weight: 600;
        }
        
        .room-item-player-bet {
            color: #ffd700;
            font-size: 0.8rem;
        }
        
        .room-item-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .room-item-action {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid rgba(255, 107, 53, 0.5);
            color: #ff6b35;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .room-item-action:hover {
            background: rgba(255, 107, 53, 0.4);
            transform: translateY(-1px);
        }
        
        /* 聊天系统样式 */
        .chat-section {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .chat-title {
            font-size: 1.3rem;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .chat-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 107, 53, 0.2);
        }
        
        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .chat-message:hover {
            background: rgba(255, 107, 53, 0.2);
        }
        
        .chat-message-avatar {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, #8b0000, #4b0082);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .chat-message-content {
            flex: 1;
        }
        
        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .chat-message-username {
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .chat-message-time {
            color: #999;
            font-size: 0.7rem;
        }
        
        .chat-message-text {
            color: #ddd;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 53, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 1rem;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: rgba(255, 107, 53, 0.5);
        }
        
        .chat-send-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }
        
        /* 游戏结果显示 */
        .game-results {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }
        
        .game-results-title {
            font-size: 1.3rem;
            color: #ff6b6b;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            transition: all 0.3s ease;
        }
        
        .result-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .result-item.win {
            background: rgba(40, 167, 69, 0.1);
            border-color: rgba(40, 167, 69, 0.3);
        }
        
        .result-item.lose {
            background: rgba(231, 76, 60, 0.1);
            border-color: rgba(231, 76, 60, 0.3);
        }
        
        .result-player {
            color: white;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .result-status {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .result-status.win {
            background: rgba(40, 167, 69, 0.2);
            color: #27ae60;
        }
        
        .result-status.lose {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .result-amount {
            color: #ffd700;
            font-weight: bold;
            font-size: 1rem;
        }
        
        /* 最新背包系统样式 */
        .backpack-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .backpack-page {
            background: linear-gradient(135deg, #1a1a1a, #2d1b1b);
            border-radius: 25px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 53, 0.3);
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .backpack-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 107, 53, 0.3);
        }
        
        .backpack-title {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .backpack-close {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .backpack-close:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: rotate(90deg);
        }
        
        .backpack-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .backpack-stat {
            background: rgba(255, 107, 53, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
        }
        
        .backpack-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .backpack-stat-label {
            color: #ff6b6b;
            font-size: 1rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .backpack-stat-value {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .backpack-categories {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .backpack-category {
            background: rgba(255, 107, 53, 0.2);
            border: 1px solid rgba(255, 107, 53, 0.5);
            color: #ff6b35;
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .backpack-category.active {
            background: rgba(255, 107, 53, 0.5);
            color: white;
        }
        
        .backpack-category:hover:not(.active) {
            background: rgba(255, 107, 53, 0.4);
            transform: translateY(-1px);
        }
        
        .backpack-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .backpack-item {
            background: rgba(255, 107, 53, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .backpack-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 107, 53, 0.3);
        }
        
        .backpack-item.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .backpack-item-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            position: relative;
        }
        
        .backpack-item-rarity {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .backpack-item-rarity.legendary {
            background: linear-gradient(135deg, #ff0000, #8b0000);
        }
        
        .backpack-item-rarity.epic {
            background: linear-gradient(135deg, #9933ff, #6600cc);
        }
        
        .backpack-item-rarity.rare {
            background: linear-gradient(135deg, #00bcd4, #0088cc);
        }
        
        .backpack-item-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            margin-bottom: 8px;
        }
        
        .backpack-item-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
        }
        
        .backpack-item-desc {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .backpack-item-stats {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.8rem;
            color: #ccc;
        }
        
        .backpack-item-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .backpack-item-action {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            flex: 1;
        }
        
        .backpack-item-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }
        
        .backpack-item-action:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .backpack-item-action.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .backpack-item-action.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .backpack-item-action.sell {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .backpack-item-action.sell:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        /* 物品详情模态框 */
        .item-detail-modal {
            background: linear-gradient(135deg, #1a1a1a, #2d1b1b);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 53, 0.3);
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
        }
        
        .item-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
        }
        
        .item-detail-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .item-detail-close {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .item-detail-close:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: rotate(90deg);
        }
        
        .item-detail-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .item-detail-info {
            background: rgba(255, 107, 53, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .item-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: white;
            font-size: 1rem;
        }
        
        .item-detail-label {
            color: #ff6b6b;
            font-weight: 600;
        }
        
        .item-detail-value {
            font-weight: bold;
        }
        
        .item-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* 每日任务弹窗 */
        .tasks-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .tasks-page {
            background: linear-gradient(135deg, #1a1a1a, #2d1b1b);
            border-radius: 25px;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 53, 0.3);
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
        }
        
        .tasks-title {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .task-item {
            background: rgba(255, 107, 53, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .task-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }
        
        .task-reward {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 5px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .task-desc {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .task-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            flex: 1;
            height: 10px;
            background: rgba(255, 107, 53, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-right: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            min-width: 80px;
        }
        
        .task-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .task-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }
        
        .task-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 积分明细弹窗 */
        .points-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: modalFadeIn 0.3s ease-out;
        }
        
        .points-page {
            background: linear-gradient(135deg, #1a1a1a, #2d1b1b);
            border-radius: 25px;
            padding: 40px;
            max-width: 700px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 107, 53, 0.3);
            position: relative;
            animation: modalSlideUp 0.3s ease-out;
        }
        
        .points-title {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .points-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .points-stat {
            background: rgba(255, 107, 53, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
        }
        
        .points-stat:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .stat-label {
            color: #ff6b6b;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .stat-value {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-value.positive {
            color: #00ff00;
        }
        
        .stat-value.negative {
            color: #ff0000;
        }
        
        .points-history {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 30px;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: rgba(255, 107, 53, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 53, 0.2);
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.2);
        }
        
        .history-desc {
            color: white;
            font-weight: 600;
        }
        
        .history-amount {
            font-weight: bold;
        }
        
        .history-amount.positive {
            color: #00ff00;
        }
        
        .history-amount.negative {
            color: #ff0000;
        }
        
        /* 消息提示 */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            animation: messageSlideIn 0.3s ease-out;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 300px;
        }
        
        @keyframes messageSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .message.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .message.error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .message.info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .rooms-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .game-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .bet-controls {
                flex-direction: column;
            }
            
            .win-streak {
                bottom: 10px;
                right: 10px;
                padding: 10px 15px;
            }
            
            .backpack-items {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .backpack-stats {
                grid-template-columns: 1fr;
            }
            
            .points-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 恐怖背景 -->
    <div class="horror-bg"></div>
    <div class="grandma-reflection"></div>
    <div class="weather-effect" id="weatherEffect"></div>
    <div class="lightning" id="lightning"></div>
    
    <!-- 主容器 -->
    <div class="main-container">
        <!-- 顶部导航 -->
        <div class="top-nav">
            <div class="logo-section">
                <div class="logo-icon">👵</div>
                <div class="logo-text">恐怖奶奶</div>
            </div>
            
            <div class="nav-buttons">
                <button class="nav-btn" onclick="location.href='index.html'">🏠 返回首页</button>
                <button class="nav-btn" onclick="GrandmaGame.showBackpack()">🎒 背包</button>
                <button class="nav-btn" onclick="GrandmaGame.showDailyTasks()">📋 每日任务</button>
                <button class="nav-btn" onclick="GrandmaGame.showPointsDetails()">💰 积分明细</button>
                <button class="nav-btn" onclick="GrandmaGame.toggleMultiplayerMode()">🎮 多人模式</button>
            </div>
            
            <div class="user-info">
                <div class="user-avatar">👤</div>
                <div class="user-details">
                    <div class="user-name" id="userName">加载中...</div>
                    <div>
                        <span class="user-points">💰 <span id="userPoints">0</span></span>
                        <span class="user-canes">🦯 <span id="userCanes">0</span></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 游戏统计 -->
        <div class="game-stats">
            <div class="stat-card">
                <div class="stat-label">当前回合</div>
                <div class="stat-value" id="currentRound">1</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">奖金池</div>
                <div class="stat-value">💰 <span id="prizePoolAmount">0</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">在线玩家</div>
                <div class="stat-value" id="onlinePlayers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">总投注</div>
                <div class="stat-value">💰 <span id="totalBets">0</span></div>
            </div>
        </div>
        
        <!-- 主游戏区域 -->
        <div class="game-container">
            <div class="game-area">
                <div class="game-title">
                    <span class="grandma-icon">👵</span>
                    <span>恐怖奶奶房间</span>
                    <span class="grandma-icon">🏚️</span>
                </div>
                
                <!-- 游戏模式切换 -->
                <div class="multiplayer-section" id="multiplayerSection" style="display: none;">
                    <div class="multiplayer-title">🎮 多人游戏模式</div>
                    <div class="multiplayer-controls">
                        <button class="multiplayer-btn" onclick="createMultiplayerRoom()">创建房间</button>
                        <button class="multiplayer-btn secondary" onclick="joinRandomRoom()">随机加入</button>
                        <button class="multiplayer-btn secondary" onclick="GrandmaGame.showRoomsList()">房间列表</button>
                    </div>
                    <div class="rooms-list" id="roomsList">
                        <!-- 房间列表将在这里动态生成 -->
                    </div>
                </div>
                
                <!-- 游戏计时器 -->
                <div class="game-timer">
                    <div class="timer-display" id="timerDisplay">30</div>
                    <div class="timer-status" id="timerStatus">准备阶段</div>
                </div>
                
                <!-- 房间网格 -->
                <div class="rooms-container" id="roomsContainer">
                    <!-- 房间将在这里动态生成 -->
                </div>
                
                <!-- 投注区域 -->
                <div class="betting-area">
                    <div class="betting-title">💰 投注区域</div>
                    <div class="bet-controls">
                        <input type="number" class="bet-input" id="betAmount" placeholder="输入投注金额" min="1" max="1000">
                        <button class="bet-btn" id="betBtn" onclick="placeBet()">确认投注</button>
                    </div>
                    <div class="quick-bet-buttons">
                        <button class="quick-bet" onclick="quickBet(10)">10</button>
                        <button class="quick-bet" onclick="quickBet(50)">50</button>
                        <button class="quick-bet" onclick="quickBet(100)">100</button>
                        <button class="quick-bet" onclick="quickBet(500)">500</button>
                    </div>
                </div>
            </div>
            
            <!-- 侧边栏 -->
            <div class="sidebar">
                <!-- 聊天系统 -->
                <div class="chat-section">
                    <div class="chat-title">💬 聊天室</div>
                    <div class="chat-container" id="chatContainer">
                        <!-- 聊天消息将在这里动态生成 -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput" placeholder="输入消息..." maxlength="100">
                        <button class="chat-send-btn" onclick="sendMessage()">发送</button>
                    </div>
                </div>
                
                <!-- 奖金池 -->
                <div class="prize-pool">
                    <div class="prize-pool-title">🏆 奖金池</div>
                    <div class="prize-amount">💰 <span id="prizePoolDisplay">0</span></div>
                    <div class="prize-info">前十名瓜分</div>
                </div>
                
                <!-- 游戏结果 -->
                <div class="game-results" id="gameResults" style="display: none;">
                    <div class="game-results-title">🎮 游戏结果</div>
                    <div class="results-list" id="resultsList">
                        <!-- 游戏结果将在这里动态生成 -->
                    </div>
                </div>
                
                <!-- 历史记录 -->
                <div class="history-section">
                    <div class="history-title">📜 奶奶近十期去向</div>
                    <div class="history-list" id="historyList">
                        <!-- 历史记录将在这里动态生成 -->
                    </div>
                </div>
                
                <!-- 排行榜 -->
                <div class="leaderboard">
                    <div class="leaderboard-title">📊 排行榜</div>
                    <div class="leaderboard-tabs">
                        <div class="leaderboard-tab active" onclick="switchLeaderboard('bet')">投注榜</div>
                        <div class="leaderboard-tab" onclick="switchLeaderboard('streak')">连胜榜</div>
                    </div>
                    <div class="leaderboard-list" id="leaderboardList">
                        <!-- 排行榜数据将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 连胜显示 -->
    <div class="win-streak" id="winStreak">
        <div class="streak-text">连胜</div>
        <div class="streak-number" id="streakNumber">0</div>
    </div>

    <script>
        // 恐怖奶奶游戏系统 - 联机增强版
        const GrandmaGame = {
            // 游戏状态
            gameState: {
                currentRound: 1,
                timeLeft: 30,
                isLocked: false,
                selectedRoom: null,
                betAmount: 0,
                totalBets: 0,
                prizePool: 0,
                winStreak: 0,
                hasProtection: false,
                rooms: [],
                players: {},
                leaderboard: {
                    bet: [],
                    streak: []
                },
                history: [],
                grandmaAppeared: false,
                userPoints: 0,
                roundEnded: false,
                // 新增状态
                userCanes: 0,
                dailyTasks: {
                    task1: { completed: 0, target: 10, claimed: false },
                    task2: { completed: 0, target: 30, claimed: false },
                    task3: { completed: 0, target: 10, claimed: false, count: 0 }
                },
                pointsHistory: [],
                totalInvested: 0,
                totalEarned: 0,
                // 最新背包系统
                backpack: {
                    items: [],
                    capacity: 50,
                    categories: ['all', 'consumable', 'equipment', 'special', 'currency'],
                    selectedCategory: 'all'
                },
                // 联机模式状态
                multiplayerMode: false,
                currentGameRoom: null,
                isHost: false,
                roomPlayers: []
            },
            
            // 房间配置
            roomConfig: [
                { id: 1, name: '卧室', icon: '🛏️' },
                { id: 2, name: '厨房', icon: '🍳' },
                { id: 3, name: '客厅', icon: '🛋️' },
                { id: 4, name: '浴室', icon: '🚿' },
                { id: 5, name: '书房', icon: '📚' },
                { id: 6, name: '储藏室', icon: '📦' },
                { id: 7, name: '阳台', icon: '🌺' },
                { id: 8, name: '地下室', icon: '🔦' }
            ],
            
            // 物品配置
            itemConfig: {
                // 消耗品
                'cane': {
                    id: 'cane',
                    name: '奶奶的拐杖',
                    icon: '🦯',
                    description: '每10积分被奶奶抓走可获得1个拐杖，使用后下次被抓免受损失',
                    category: 'consumable',
                    rarity: 'common',
                    value: 10,
                    usable: true,
                    consumable: true,
                    stackable: true,
                    maxStack: 99
                },
                'protection': {
                    id: 'protection',
                    name: '免伤卡',
                    icon: '🛡️',
                    description: '可抵挡一次奶奶的抓捕，使用后下次被抓免受损失',
                    category: 'consumable',
                    rarity: 'rare',
                    value: 100,
                    usable: true,
                    consumable: true,
                    stackable: true,
                    maxStack: 10
                },
                'lucky_charm': {
                    id: 'lucky_charm',
                    name: '幸运符',
                    icon: '🍀',
                    description: '增加10%的存活概率，使用后下一回合生效',
                    category: 'consumable',
                    rarity: 'epic',
                    value: 50,
                    usable: true,
                    consumable: true,
                    stackable: true,
                    maxStack: 5
                },
                'speed_boost': {
                    id: 'speed_boost',
                    name: '加速药水',
                    icon: '⚡',
                    description: '减少5秒投注锁定时间，使用后立即生效',
                    category: 'consumable',
                    rarity: 'rare',
                    value: 30,
                    usable: true,
                    consumable: true,
                    stackable: true,
                    maxStack: 10
                },
                'double_reward': {
                    id: 'double_reward',
                    name: '双倍奖励卡',
                    icon: '💎',
                    description: '下次获胜获得双倍奖励，使用后下一回合生效',
                    category: 'consumable',
                    rarity: 'legendary',
                    value: 200,
                    usable: true,
                    consumable: true,
                    stackable: true,
                    maxStack: 3
                },
                // 装备品
                'night_vision': {
                    id: 'night_vision',
                    name: '夜视仪',
                    icon: '👓',
                    description: '显示奶奶的真实位置，增加30%的存活概率',
                    category: 'equipment',
                    rarity: 'epic',
                    value: 150,
                    usable: true,
                    consumable: false,
                    stackable: false,
                    maxStack: 1
                },
                'stealth_boots': {
                    id: 'stealth_boots',
                    name: '隐身靴',
                    icon: '👟',
                    description: '减少50%被抓的概率，装备后持续生效',
                    category: 'equipment',
                    rarity: 'rare',
                    value: 80,
                    usable: true,
                    consumable: false,
                    stackable: false,
                    maxStack: 1
                },
                'lucky_amulet': {
                    id: 'lucky_amulet',
                    name: '幸运护身符',
                    icon: '🧿',
                    description: '增加20%的存活概率，装备后持续生效',
                    category: 'equipment',
                    rarity: 'rare',
                    value: 60,
                    usable: true,
                    consumable: false,
                    stackable: false,
                    maxStack: 1
                },
                // 特殊物品
                'grandma_photo': {
                    id: 'grandma_photo',
                    name: '奶奶的照片',
                    icon: '📷',
                    description: '神秘的奶奶照片，据说能带来好运',
                    category: 'special',
                    rarity: 'legendary',
                    value: 500,
                    usable: false,
                    consumable: false,
                    stackable: true,
                    maxStack: 1
                },
                'haunted_key': {
                    id: 'haunted_key',
                    name: '闹鬼钥匙',
                    icon: '🗝️',
                    description: '可以打开秘密房间的钥匙',
                    category: 'special',
                    rarity: 'epic',
                    value: 300,
                    usable: false,
                    consumable: false,
                    stackable: true,
                    maxStack: 3
                },
                // 货币
                'mystery_box': {
                    id: 'mystery_box',
                    name: '神秘盲盒',
                    icon: '🎁',
                    description: '包含随机道具的神秘盲盒',
                    category: 'currency',
                    rarity: 'legendary',
                    value: 100,
                    usable: true,
                    consumable: true,
                    stackable: true,
                    maxStack: 99
                }
            },
            
            // Socket.io 连接
            socket: null,
            
            // 初始化游戏
            init() {
                console.log('=== 初始化恐怖奶奶游戏 ===');
                
                // 初始化Socket.io
                this.initSocket();
                
                // 检查登录状态
                if (!this.checkLogin()) {
                    return;
                }
                
                // 初始化用户数据
                this.loadUserData();
                
                // 初始化房间
                this.initRooms();
                
                // 初始化其他功能
                this.startGameTimer();
                this.updateLeaderboard();
                this.simulatePlayers();
                this.startWeatherEffect();
                
                // 随机闪电效果
                setInterval(() => {
                    if (Math.random() < 0.1) {
                        const lightning = document.getElementById('lightning');
                        lightning.classList.add('flash');
                        setTimeout(() => {
                            lightning.classList.remove('flash');
                        }, 300);
                    }
                }, 5000);
                
                console.log('游戏初始化完成');
            },
            
            // 初始化Socket.io
            initSocket() {
                this.socket = io('http://localhost:3000');
                
                // 连接成功
                this.socket.on('connect', () => {
                    console.log('Socket.io连接成功');
                    
                    // 发送用户登录信息
                    const user = JSON.parse(localStorage.getItem('currentUser'));
                    if (user) {
                        this.socket.emit('userLogin', user);
                    }
                });
                
                // 接收在线用户列表
                this.socket.on('onlineUsers', (users) => {
                    document.getElementById('onlinePlayers').textContent = users.length;
                    console.log('在线用户:', users);
                });
                
                // 接收用户上线通知
                this.socket.on('userOnline', (user) => {
                    this.showMessage(`${user.username} 上线了`, 'info');
                });
                
                // 接收用户下线通知
                this.socket.on('userOffline', (user) => {
                    this.showMessage(`${user.username} 下线了`, 'info');
                });
                
                // 接收房间创建成功
                this.socket.on('gameRoomCreated', (data) => {
                    const { gameRoom, userPoints } = data;
                    this.showMessage(`房间创建成功！房间ID: ${gameRoom.id}`, 'success');
                    this.gameState.userPoints = userPoints;
                    this.gameState.currentGameRoom = gameRoom.id;
                    this.updatePointsDisplay();
                    this.showGameRoomInfo(gameRoom);
                });
                
                // 接收玩家加入通知
                this.socket.on('playerJoined', (data) => {
                    const { player, gameRoom, userPoints } = data;
                    this.showMessage(`${player.username} 加入了房间`, 'info');
                    this.gameState.userPoints = userPoints;
                    this.updatePointsDisplay();
                    this.updateGameRoomDisplay(gameRoom);
                });
                
                // 接收游戏开始
                this.socket.on('gameStart', (data) => {
                    const { dangerRooms, gameRoom, duration } = data;
                    this.gameState.dangerRooms = dangerRooms;
                    this.gameState.isLocked = true;
                    this.gameState.currentGameRoom = gameRoom;
                    
                    // 显示危险房间
                    this.updateDangerRooms(dangerRooms);
                    
                    // 开始倒计时
                    this.startGameTimer(duration);
                    
                    this.showMessage('游戏开始！小心危险房间！', 'warning');
                });
                
                // 接收游戏结果
                this.socket.on('gameResult', (data) => {
                    const { result, winAmount, canesGained, newPoints, dangerRooms } = data;
                    
                    if (result === 'win') {
                        this.showMessage(`🎉 恭喜获胜！获得${winAmount}积分`, 'success');
                    } else {
                        this.showMessage(`😢 很遗憾，获得${canesGained}个拐杖`, 'error');
                    }
                    
                    this.gameState.userPoints = newPoints;
                    this.updatePointsDisplay();
                    
                    // 显示危险房间
                    this.updateDangerRooms(dangerRooms);
                });
                
                // 接收游戏结束
                this.socket.on('gameEnd', (data) => {
                    const { gameRoom, dangerRooms, results } = data;
                    this.showGameResults(results);
                    this.gameState.currentGameRoom = null;
                    this.gameState.isLocked = false;
                });
                
                // 接收房间列表
                this.socket.on('gameRoomsList', (rooms) => {
                    this.displayGameRooms(rooms);
                });
                
                // 接收排行榜更新
                this.socket.on('leaderboardUpdate', (leaderboard) => {
                    this.updateLeaderboardDisplay(leaderboard);
                });
                
                // 接收新消息
                this.socket.on('newMessage', (message) => {
                    this.displayChatMessage(message);
                });
                
                // 接收积分更新
                this.socket.on('pointsUpdated', (data) => {
                    const { newPoints, amount, reason } = data;
                    this.gameState.userPoints = newPoints;
                    this.updatePointsDisplay();
                    this.showMessage(`${reason}: ${amount > 0 ? '+' : ''}${amount}积分`, 'info');
                });
                
                // 断开连接
                this.socket.on('disconnect', () => {
                    console.log('Socket.io连接断开');
                });
            },
            
            // 检查登录状态
            checkLogin() {
                const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                const currentUser = localStorage.getItem('currentUser');
                
                if (!isLoggedIn || !currentUser) {
                    console.log('用户未登录，跳转到登录页面');
                    window.location.href = 'login.html';
                    return false;
                }
                
                return true;
            },
            
            // 加载用户数据
            loadUserData() {
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                this.gameState.userPoints = user.points || 1000;
                this.gameState.userCanes = user.canes || 0;
                
                // 加载任务进度
                const savedTasks = localStorage.getItem('grandmaDailyTasks');
                if (savedTasks) {
                    this.gameState.dailyTasks = JSON.parse(savedTasks);
                }
                
                // 加载积分历史
                const savedHistory = localStorage.getItem('grandmaPointsHistory');
                if (savedHistory) {
                    this.gameState.pointsHistory = JSON.parse(savedHistory);
                }
                
                // 加载背包数据
                const savedBackpack = localStorage.getItem('grandmaBackpack');
                if (savedBackpack) {
                    this.gameState.backpack = JSON.parse(savedBackpack);
                }
                
                // 初始化默认物品
                this.initializeDefaultItems();
                
                // 计算总投入和总收入
                this.calculatePointsStats();
                
                // 更新UI
                this.updateUserInfo();
                this.updatePointsDisplay();
                
                console.log('加载用户数据完成');
            },
            
            // 初始化默认物品
            initializeDefaultItems() {
                // 如果背包为空，添加一些默认物品
                if (this.gameState.backpack.items.length === 0) {
                    // 添加初始拐杖
                    if (this.gameState.userCanes > 0) {
                        this.gameState.backpack.items.push({
                            ...this.itemConfig['cane'],
                            count: this.gameState.userCanes
                        });
                    }
                    
                    // 添加初始神秘盲盒
                    this.gameState.backpack.items.push({
                        ...this.itemConfig['mystery_box'],
                        count: 1
                    });
                }
            },
            
            // 保存用户数据
            saveUserData() {
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                user.points = this.gameState.userPoints;
                user.canes = this.gameState.userCanes;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // 保存任务进度
                localStorage.setItem('grandmaDailyTasks', JSON.stringify(this.gameState.dailyTasks));
                
                // 保存积分历史
                localStorage.setItem('grandmaPointsHistory', JSON.stringify(this.gameState.pointsHistory));
                
                // 保存背包数据
                localStorage.setItem('grandmaBackpack', JSON.stringify(this.gameState.backpack));
                
                // 同时更新积分系统
                if (window.pointsSystem) {
                    window.pointsSystem.currentUser = user;
                    window.pointsSystem.updatePoints(0, '同步积分', { sync: true });
                }
                
                console.log('保存用户数据完成');
            },
            
            // 计算积分统计
            calculatePointsStats() {
                this.gameState.totalInvested = 0;
                this.gameState.totalEarned = 0;
                
                this.gameState.pointsHistory.forEach(record => {
                    if (record.type === 'invest') {
                        this.gameState.totalInvested += record.amount;
                    } else if (record.type === 'earn') {
                        this.gameState.totalEarned += record.amount;
                    }
                });
            },
            
            // 更新用户信息
            updateUserInfo() {
                const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userName = document.getElementById('userName');
                const userCanes = document.getElementById('userCanes');
                
                if (userName && userCanes) {
                    userName.textContent = user.name;
                    userCanes.textContent = this.gameState.userCanes;
                }
            },
            
            // 更新积分显示
            updatePointsDisplay() {
                console.log('更新积分显示:', this.gameState.userPoints);
                
                // 更新所有显示积分的元素
                const pointsElements = document.querySelectorAll('[id*="userPoints"], [class*="user-points"]');
                pointsElements.forEach(element => {
                    if (element.tagName === 'SPAN') {
                        element.textContent = this.gameState.userPoints;
                    } else if (element.tagName === 'DIV') {
                        const span = element.querySelector('span');
                        if (span) {
                            span.textContent = this.gameState.userPoints;
                        } else {
                            element.textContent = `💰 ${this.gameState.userPoints}`;
                        }
                    }
                });
                
                // 更新特定的积分显示
                const specificElements = [
                    'userPoints',
                    'prizePoolAmount',
                    'prizePoolDisplay',
                    'totalBets'
                ];
                
                specificElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = this.gameState.userPoints;
                    }
                });
            },
            
            // 初始化房间
            initRooms() {
                const container = document.getElementById('roomsContainer');
                container.innerHTML = '';
                
                this.gameState.rooms = [];
                
                this.roomConfig.forEach(config => {
                    const room = {
                        ...config,
                        danger: false,
                        players: 0,
                        totalBet: 0
                    };
                    
                    this.gameState.rooms.push(room);
                    
                    const roomElement = this.createRoomElement(room);
                    container.appendChild(roomElement);
                });
            },
            
            // 创建房间元素
            createRoomElement(room) {
                const div = document.createElement('div');
                div.className = 'room';
                div.id = `room-${room.id}`;
                div.onclick = () => this.selectRoom(room.id);
                
                div.innerHTML = `
                    <div class="room-icon">${room.icon}</div>
                    <div class="room-name">${room.name}</div>
                    <div class="room-pool">奖池: 💰<span class="room-pool-amount">0</span></div>
                    <div class="room-players">玩家: <span class="room-players-count">0</span></div>
                    <div class="room-bet" style="display: none;" id="room-bet-${room.id}">💰<span class="room-bet-amount">0</span></div>
                `;
                
                return div;
            },
            
            // 选择房间
            selectRoom(roomId) {
                if (this.gameState.isLocked || this.gameState.roundEnded) {
                    this.showMessage('投注已锁定，请等待下一回合', 'error');
                    return;
                }
                
                // 如果已有投注，转移到新房间
                if (this.gameState.betAmount > 0 && this.gameState.selectedRoom) {
                    // 移除旧房间的投注角标
                    const oldBetElement = document.getElementById(`room-bet-${this.gameState.selectedRoom}`);
                    if (oldBetElement) {
                        oldBetElement.style.display = 'none';
                    }
                    
                    const oldRoom = this.gameState.rooms.find(r => r.id === this.gameState.selectedRoom);
                    oldRoom.totalBet -= this.gameState.betAmount;
                    oldRoom.players--;
                    this.updateRoomDisplay(oldRoom);
                }
                
                // 移除之前的选中状态
                document.querySelectorAll('.room').forEach(room => {
                    room.classList.remove('selected');
                });
                
                // 添加新的选中状态
                const selectedRoom = document.getElementById(`room-${roomId}`);
                selectedRoom.classList.add('selected');
                
                this.gameState.selectedRoom = roomId;
                
                // 如果已有投注，更新新房间
                if (this.gameState.betAmount > 0) {
                    const newRoom = this.gameState.rooms.find(r => r.id === roomId);
                    newRoom.totalBet += this.gameState.betAmount;
                    newRoom.players++;
                    this.updateRoomDisplay(newRoom);
                    
                    // 显示投注信息
                    const betElement = document.getElementById(`room-bet-${roomId}`);
                    const betAmountDisplay = betElement.querySelector('.room-bet-amount');
                    betElement.style.display = 'block';
                    betAmountDisplay.textContent = this.gameState.betAmount;
                }
            },
            
            // 更新房间显示
            updateRoomDisplay(room) {
                const roomElement = document.getElementById(`room-${room.id}`);
                roomElement.querySelector('.room-pool-amount').textContent = room.totalBet;
                roomElement.querySelector('.room-players-count').textContent = room.players;
            },
            
            // 快速投注
            quickBet(amount) {
                document.getElementById('betAmount').value = amount;
            },
            
            // 投注
            placeBet() {
                console.log('=== 开始投注 ===');
                
                if (this.gameState.isLocked || this.gameState.roundEnded) {
                    this.showMessage('投注已锁定，请等待下一回合', 'error');
                    return;
                }
                
                if (!this.gameState.selectedRoom) {
                    this.showMessage('请先选择房间', 'error');
                    return;
                }
                
                const betInput = document.getElementById('betAmount');
                const additionalAmount = parseInt(betInput.value);
                
                if (!additionalAmount || additionalAmount < 1) {
                    this.showMessage('请输入有效的投注金额', 'error');
                    return;
                }
                
                // 检查积分是否足够
                if (this.gameState.userPoints < additionalAmount) {
                    this.showMessage('积分不足！', 'error');
                    return;
                }
                
                console.log('投注金额:', additionalAmount);
                console.log('当前积分:', this.gameState.userPoints);
                
                // 扣除积分
                this.gameState.userPoints -= additionalAmount;
                this.gameState.betAmount += additionalAmount;
                this.gameState.totalBets += additionalAmount;
                
                // 记录积分历史
                this.addPointsHistory('invest', additionalAmount, '游戏投注');
                
                // 5%手续费，3%进入奖金池
                const fee = Math.floor(additionalAmount * 0.05);
                const poolContribution = Math.floor(additionalAmount * 0.03);
                this.gameState.prizePool += poolContribution;
                
                // 更新房间投注
                const room = this.gameState.rooms.find(r => r.id === this.gameState.selectedRoom);
                room.totalBet += additionalAmount;
                room.players++;
                
                // 显示投注信息
                const roomElement = document.getElementById(`room-${this.gameState.selectedRoom}`);
                const betElement = document.getElementById(`room-bet-${this.gameState.selectedRoom}`);
                const betAmountDisplay = betElement.querySelector('.room-bet-amount');
                betElement.style.display = 'block';
                betAmountDisplay.textContent = this.gameState.betAmount;
                
                // 立即更新UI
                this.updatePointsDisplay();
                this.saveUserData();
                
                // 显示金额注入动画
                this.showMoneyInjection(additionalAmount);
                
                this.showMessage(`成功投注 ${additionalAmount} 积分到${room.name}，总投注: ${this.gameState.betAmount}`, 'success');
                
                // 清空投注输入
                betInput.value = '';
                
                // 更新统计
                this.updateStats();
                
                // 更新任务进度
                this.updateTaskProgress('task1', additionalAmount);
                
                console.log('投注完成，剩余积分:', this.gameState.userPoints);
            },
            
            // 显示金额注入动画
            showMoneyInjection(amount) {
                const selectedRoom = document.getElementById(`room-${this.gameState.selectedRoom}`);
                const injection = document.createElement('div');
                injection.className = 'money-injection';
                injection.textContent = `+${amount}`;
                injection.style.cssText = `
                    position: absolute;
                    font-size: 1.2rem;
                    font-weight: 700;
                    color: #00ff00;
                    pointer-events: none;
                    animation: moneyFloat 2s ease-out forwards;
                    z-index: 6;
                    text-shadow: 0 2px 10px rgba(0, 255, 0, 0.8);
                `;
                injection.style.left = '50%';
                injection.style.top = '50%';
                injection.style.transform = 'translate(-50%, -50%)';
                
                selectedRoom.appendChild(injection);
                
                // 动画结束后移除
                setTimeout(() => {
                    if (injection.parentNode) {
                        injection.parentNode.removeChild(injection);
                    }
                }, 2000);
            },
            
            // 游戏计时器
            startGameTimer() {
                setInterval(() => {
                    if (this.gameState.roundEnded) return;
                    
                    this.gameState.timeLeft--;
                    
                    const timerDisplay = document.getElementById('timerDisplay');
                    const timerStatus = document.getElementById('timerStatus');
                    
                    timerDisplay.textContent = this.gameState.timeLeft;
                    
                    if (this.gameState.timeLeft <= 5) {
                        timerDisplay.classList.add('warning');
                        timerStatus.textContent = '即将开奖';
                        this.gameState.isLocked = true;
                    } else if (this.gameState.timeLeft <= 25) {
                        timerDisplay.classList.remove('warning');
                        timerStatus.textContent = '投注时间';
                    } else {
                        timerStatus.textContent = '准备阶段';
                    }
                    
                    // 时间到，开奖
                    if (this.gameState.timeLeft <= 0) {
                        this.endRound();
                    }
                }, 1000);
            },
            
            // 结束回合
            endRound() {
                if (this.gameState.roundEnded) return;
                
                this.gameState.roundEnded = true;
                
                // 随机选择1-7个房间
                const roomCount = Math.floor(Math.random() * 7) + 1;
                const availableRooms = [...Array(8).keys()].map(i => i + 1);
                let dangerRooms = [];
                
                // 随机选择房间
                for (let i = 0; i < roomCount; i++) {
                    const randomIndex = Math.floor(Math.random() * availableRooms.length);
                    dangerRooms.push(availableRooms[randomIndex]);
                    availableRooms.splice(randomIndex, 1);
                }
                
                // 更新房间状态
                this.gameState.rooms.forEach(room => {
                    const roomElement = document.getElementById(`room-${room.id}`);
                    roomElement.classList.remove('danger', 'safe');
                    
                    if (dangerRooms.includes(room.id)) {
                        roomElement.classList.add('danger');
                        room.danger = true;
                    } else {
                        roomElement.classList.add('safe');
                        room.danger = false;
                    }
                });
                
                // 记录历史
                const historyRecord = {
                    round: this.gameState.currentRound,
                    mode: '随机',
                    rooms: dangerRooms.map(id => this.roomConfig.find(r => r.id === id).name),
                    timestamp: new Date()
                };
                
                this.gameState.history.unshift(historyRecord);
                if (this.gameState.history.length > 10) {
                    this.gameState.history.pop();
                }
                
                this.updateHistory();
                
                // 结算投注
                setTimeout(() => {
                    this.settleBets(dangerRooms);
                }, 2000);
            },
            
            // 结算投注 - 完整修复版
            settleBets(dangerRooms) {
                console.log('=== 开始结算投注 ===');
                console.log('危险房间:', dangerRooms);
                console.log('用户投注金额:', this.gameState.betAmount);
                console.log('用户选择房间:', this.gameState.selectedRoom);
                
                // 计算所有安全房间的总投注
                const totalSafeBets = this.gameState.rooms
                    .filter(room => !dangerRooms.includes(room.id))
                    .reduce((sum, room) => sum + room.totalBet, 0);
                
                // 计算所有危险房间的总投注
                const totalDangerBets = this.gameState.rooms
                    .filter(room => dangerRooms.includes(room.id))
                    .reduce((sum, room) => sum + room.totalBet, 0);
                
                console.log('存活房间总投注:', totalSafeBets);
                console.log('被抓房间总投注:', totalDangerBets);
                
                // 如果没有投注，直接重置
                if (!this.gameState.selectedRoom || this.gameState.betAmount <= 0) {
                    console.log('用户未投注，跳过结算');
                    setTimeout(() => {
                        this.resetRound();
                    }, 3000);
                    return;
                }
                
                const isWin = !dangerRooms.includes(this.gameState.selectedRoom);
                const room = this.gameState.rooms.find(r => r.id === this.gameState.selectedRoom);
                
                console.log('用户是否存活:', isWin);
                console.log('房间信息:', room);
                
                if (isWin) {
                    // 用户存活，计算收益
                    if (totalSafeBets > 0) {
                        // 计算用户投注比例
                        const userBetRatio = room.totalBet / totalSafeBets;
                        
                        // 计算可瓜分的总金额（被抓房间的95%）
                        const totalDangerPool = Math.floor(totalDangerBets * 0.95);
                        const userEarnings = Math.floor(totalDangerPool * userBetRatio);
                        
                        console.log('用户投注比例:', userBetRatio);
                        console.log('可瓜分金额:', totalDangerPool);
                        console.log('用户收益:', userEarnings);
                        
                        // 返还本金并给予收益
                        const totalReturn = this.gameState.betAmount + userEarnings;
                        
                        console.log('返还本金:', this.gameState.betAmount);
                        console.log('瓜分收益:', userEarnings);
                        console.log('总返还:', totalReturn);
                        
                        // 更新用户积分
                        this.gameState.userPoints += totalReturn;
                        this.gameState.winStreak++;
                        
                        // 记录积分历史
                        this.addPointsHistory('earn', totalReturn, '游戏获胜');
                        
                        // 立即更新UI
                        this.updatePointsDisplay();
                        this.saveUserData();
                        
                        this.showMessage(`🎉 恭喜存活！返还本金 ${this.gameState.betAmount}，瓜分收益${userEarnings} 积分`, 'success');
                        
                        // 显示结算页面
                        this.showSettlementPage(true, room, totalReturn, userEarnings);
                    } else {
                        // 如果没有其他安全投注，只返还本金
                        this.gameState.userPoints += this.gameState.betAmount;
                        this.gameState.winStreak++;
                        
                        // 记录积分历史
                        this.addPointsHistory('earn', this.gameState.betAmount, '游戏获胜');
                        
                        this.updatePointsDisplay();
                        this.saveUserData();
                        
                        this.showMessage(`🎉 恭喜存活！返还本金 ${this.gameState.betAmount}`, 'success');
                        
                        // 显示结算页面
                        this.showSettlementPage(true, room, this.gameState.betAmount, 0);
                    }
                } else {
                    // 用户被抓
                    if (!this.gameState.hasProtection) {
                        console.log('用户被抓，损失积分:', this.gameState.betAmount);
                        
                        this.gameState.winStreak = 0;
                        
                        // 记录积分历史
                        this.addPointsHistory('invest', this.gameState.betAmount, '游戏失败');
                        
                        this.showMessage(`😢 很遗憾，损失 ${this.gameState.betAmount} 积分`, 'error');
                        
                        // 显示结算页面
                        this.showSettlementPage(false, room, this.gameState.betAmount, 0);
                        
                        // 掉落拐杖
                        this.dropCanes(this.gameState.betAmount, totalDangerBets);
                        
                        // 更新任务进度
                        this.updateTaskProgress('task2', this.gameState.betAmount);
                    } else {
                        this.showMessage(`🛡️ 免伤卡生效，免受损失`, 'info');
                        this.gameState.hasProtection = false;
                        
                        // 显示结算页面
                        this.showSettlementPage(false, room, 0, 0);
                    }
                }
                
                // 更新排行榜
                this.updateLeaderboard();
                
                // 延迟重置回合
                setTimeout(() => {
                    this.resetRound();
                }, 5000);
            },
            
            // 掉落拐杖
            dropCanes(userBet, totalDangerBets) {
                // 计算总拐杖数量：每10积分被奶奶抓走可获得1个拐杖
                const totalCanes = Math.floor(totalDangerBets / 10);
                
                if (totalCanes > 0) {
                    // 计算用户应得拐杖数量
                    const userCanes = Math.floor(userBet / 10);
                    
                    if (userCanes > 0) {
                        this.gameState.userCanes += userCanes;
                        this.updateUserInfo();
                        this.saveUserData();
                        
                        this.showMessage(`🦯 获得 ${userCanes} 个拐杖`, 'success');
                    }
                }
            },
            
            // 显示结算页面
            showSettlementPage(isWin, room, betAmount, earnings) {
                console.log('=== 显示结算页面 ===');
                console.log('是否获胜:', isWin);
                console.log('房间:', room);
                console.log('投注金额:', betAmount);
                console.log('收益:', earnings);
                
                // 移除现有结算页面
                const existingSettlement = document.querySelector('.settlement-overlay');
                if (existingSettlement) {
                    existingSettlement.remove();
                }
                
                // 创建结算页面容器
                const settlementOverlay = document.createElement('div');
                settlementOverlay.className = 'settlement-overlay';
                
                // 创建结算页面
                const settlementPage = document.createElement('div');
                settlementPage.className = 'settlement-page';
                
                const roomName = room.name;
                const roomIcon = room.icon;
                
                settlementPage.innerHTML = `
                    <div class="settlement-header">
                        <div class="settlement-title">🎮 游戏结算</div>
                        <div class="settlement-round">第${this.gameState.currentRound}回合</div>
                        <button class="settlement-close" onclick="GrandmaGame.closeSettlementPage()">✕</button>
                    </div>
                    
                    <div class="settlement-result ${isWin ? 'win' : 'lose'}">
                        ${isWin ? '🎉' : '😱'}
                    </div>
                    
                    <div class="settlement-status">
                        ${isWin ? '你成功躲避了奶奶！' : '你被奶奶抓到了！'}
                    </div>
                    
                    <div class="settlement-location">
                        <div class="settlement-location-title">📍 地点</div>
                        <div class="settlement-location-name">${roomIcon}${roomName}</div>
                    </div>
                    
                    <div class="settlement-details">
                        <div class="settlement-details-row">
                            <div class="settlement-details-label">投注金额</div>
                            <div class="settlement-details-value">💰 ${this.gameState.betAmount}</div>
                        </div>
                        ${isWin ? `
                            <div class="settlement-details-row">
                                <div class="settlement-details-label">返还本金</div>
                                <div class="settlement-details-value positive">💰 ${this.gameState.betAmount}</div>
                            </div>
                            <div class="settlement-details-row">
                                <div class="settlement-details-label">瓜分收益</div>
                                <div class="settlement-details-value positive">💰 ${earnings}</div>
                            </div>
                        ` : `
                            <div class="settlement-details-row">
                                <div class="settlement-details-label">损失金额</div>
                                <div class="settlement-details-value negative">💰 ${this.gameState.betAmount}</div>
                            </div>
                        `}
                        <div class="settlement-details-row">
                            <div class="settlement-details-label">手续费</div>
                            <div class="settlement-details-value">💰 ${Math.floor(this.gameState.betAmount * 0.05)}</div>
                        </div>
                    </div>
                    
                    <div class="settlement-total ${isWin ? 'win' : 'lose'}">
                        ${isWin ? 
                            `总收益：💰 ${earnings}` : 
                            `总损失：💰 ${this.gameState.betAmount}`
                        }
                    </div>
                    
                    <div class="settlement-buttons">
                        <button class="settlement-btn secondary" onclick="GrandmaGame.closeSettlementPage()">继续游戏</button>
                        <button class="settlement-btn" onclick="GrandmaGame.confirmSettlementPage()">确认</button>
                    </div>
                `;
                
                settlementOverlay.appendChild(settlementPage);
                document.body.appendChild(settlementOverlay);
                
                console.log('结算页面已显示');
            },
            
            // 关闭结算页面
            closeSettlementPage() {
                const settlementOverlay = document.querySelector('.settlement-overlay');
                if (settlementOverlay) {
                    settlementOverlay.remove();
                    console.log('结算页面已关闭');
                }
            },
            
            // 确认结算
            confirmSettlementPage() {
                this.closeSettlementPage();
                this.resetRound();
            },
            
            // 重置回合
            resetRound() {
                this.gameState.currentRound++;
                this.gameState.timeLeft = 30;
                this.gameState.isLocked = false;
                this.gameState.betAmount = 0;
                this.gameState.selectedRoom = null;
                this.gameState.roundEnded = false;
                
                // 重置房间状态
                this.gameState.rooms.forEach(room => {
                    room.danger = false;
                    room.totalBet = 0;
                    room.players = 0;
                    this.updateRoomDisplay(room);
                });
                
                // 重置房间显示
                document.querySelectorAll('.room').forEach(room => {
                    room.classList.remove('selected', 'danger', 'safe');
                    const betDisplay = room.querySelector('.room-bet');
                    if (betDisplay) {
                        betDisplay.style.display = 'none';
                    }
                });
                
                // 更新统计
                document.getElementById('currentRound').textContent = this.gameState.currentRound;
                this.updateStats();
                
                console.log('回合重置完成');
            },
            
            // 更新统计
            updateStats() {
                document.getElementById('prizePoolAmount').textContent = this.gameState.prizePool;
                document.getElementById('prizePoolDisplay').textContent = this.gameState.prizePool;
                document.getElementById('totalBets').textContent = this.gameState.totalBets;
                document.getElementById('streakNumber').textContent = this.gameState.winStreak;
            },
            
            // 更新历史记录
            updateHistory() {
                const container = document.getElementById('historyList');
                
                if (this.gameState.history.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666;">暂无记录</div>';
                    return;
                }
                
                container.innerHTML = this.gameState.history.map(record => `
                    <div class="history-item">
                        <div class="history-round">${record.round}期</div>
                        <div class="history-rooms">
                            ${record.rooms.join('，')}
                            <div class="history-mode">${record.mode}模式</div>
                        </div>
                    </div>
                `).join('');
            },
            
            // 更新排行榜
            updateLeaderboard() {
                // 模拟真实玩家数据
                const realPlayers = [
                    { name: '天创玩家1', value: 3200, rank: 1 },
                    { name: '天创玩家2', value: 2100, rank: 2 },
                    { name: '天创玩家3', value: 1500, rank: 3 },
                    { name: '天创玩家4', value: 900, rank: 4 },
                    { name: '天创玩家5', value: 750, rank: 5 },
                    { name: '天创玩家6', value: 600, rank: 6 },
                    { name: '天创玩家7', value: 550, rank: 7 },
                    { name: '天创玩家8', value: 520, rank: 8 },
                    { name: '天创玩家9', value: 510, rank: 9 },
                    { name: '天创玩家10', value: 500, rank: 10 }
                ];
                
                this.gameState.leaderboard.bet = realPlayers;
                
                this.gameState.leaderboard.streak = [
                    { name: '连胜王1', value: 15, rank: 1 },
                    { name: '连胜王2', value: 12, rank: 2 },
                    { name: '连胜王3', value: 10, rank: 3 },
                    { name: '连胜王4', value: 8, rank: 4 },
                    { name: '连胜王5', value: 6, rank: 5 }
                ];
                
                this.displayLeaderboard('bet');
            },
            
            // 显示排行榜
            displayLeaderboard(type) {
                const container = document.getElementById('leaderboardList');
                const data = this.gameState.leaderboard[type];
                
                container.innerHTML = data.map((player, index) => {
                    let rankClass = '';
                    if (index === 0) rankClass = 'gold';
                    else if (index === 1) rankClass = 'silver';
                    else if (index === 2) rankClass = 'bronze';
                    
                    return `
                        <div class="leaderboard-item">
                            <div class="leaderboard-rank ${rankClass}">${player.rank}</div>
                            <div class="leaderboard-name">${player.name}</div>
                            <div class="leaderboard-value">${type === 'bet' ? '💰' : '🔥'}${player.value}</div>
                        </div>
                    `;
                }).join('');
            },
            
            // 切换排行榜
            switchLeaderboard(type) {
                // 更新标签状态
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // 显示对应排行榜
                this.displayLeaderboard(type);
            },
            
            // 模拟玩家
            simulatePlayers() {
                setInterval(() => {
                    if (!this.gameState.isLocked && !this.gameState.roundEnded) {
                        // 随机添加人机投注
                        const botCount = Math.floor(Math.random() * 5) + 1;
                        
                        for (let i = 0; i < botCount; i++) {
                            const roomId = Math.floor(Math.random() * 8) + 1;
                            const betAmount = Math.floor(Math.random() * 5) + 1; // 1-5积分随机
                            
                            const room = this.gameState.rooms.find(r => r.id === roomId);
                            room.totalBet += betAmount;
                            room.players++;
                            this.updateRoomDisplay(room);
                            
                            // 添加人机投注角标
                            const betElement = document.getElementById(`room-bet-${roomId}`);
                            if (betElement) {
                                betElement.style.display = 'block';
                                betElement.querySelector('.room-bet-amount').textContent = betAmount;
                            }
                        }
                        
                        // 更新在线玩家数
                        const onlineCount = Math.floor(Math.random() * 50) + 20;
                        document.getElementById('onlinePlayers').textContent = onlineCount;
                    }
                }, 3000);
            },
            
            // 开始天气效果
            startWeatherEffect() {
                const weatherEffect = document.getElementById('weatherEffect');
                
                setInterval(() => {
                    if (Math.random() < 0.3) {
                        weatherEffect.classList.add('blood-rain');
                        setTimeout(() => {
                            weatherEffect.classList.remove('blood-rain');
                        }, 5000);
                    }
                }, 15000);
            },
            
            // 切换多人模式
            toggleMultiplayerMode() {
                this.gameState.multiplayerMode = !this.gameState.multiplayerMode;
                
                const multiplayerSection = document.getElementById('multiplayerSection');
                if (multiplayerSection) {
                    multiplayerSection.style.display = this.gameState.multiplayerMode ? 'block' : 'none';
                }
                
                if (this.gameState.multiplayerMode) {
                    this.showMessage('多人模式已开启', 'success');
                    this.getGameRooms();
                } else {
                    this.showMessage('多人模式已关闭', 'info');
                }
            },
            
            // 创建多人游戏房间
            createMultiplayerRoom() {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                const roomId = this.gameState.selectedRoom || Math.floor(Math.random() * 8) + 1;
                const betAmount = parseInt(document.getElementById('betAmount').value) || 50;
                
                if (!roomId || !betAmount) {
                    this.showMessage('请先选择房间并输入投注金额', 'error');
                    return;
                }
                
                if (this.gameState.userPoints < betAmount) {
                    this.showMessage('积分不足', 'error');
                    return;
                }
                
                this.socket.emit('createGameRoom', {
                    userId: user.id,
                    roomId,
                    betAmount
                });
            },
            
            // 随机加入房间
            joinRandomRoom() {
                this.getGameRooms();
                
                const rooms = document.querySelectorAll('.room-item');
                if (rooms.length === 0) {
                    this.showMessage('暂无可加入的房间', 'info');
                    return;
                }
                
                const randomIndex = Math.floor(Math.random() * rooms.length);
                const roomId = rooms[randomIndex].getAttribute('data-room-id');
                
                this.joinGameRoom(roomId);
            },
            
            // 加入游戏房间
            joinGameRoom(roomId) {
                const user = JSON.parse(localStorage.getItem('currentUser'));
                const betAmount = parseInt(document.getElementById('betAmount').value) || 50;
                
                if (!betAmount) {
                    this.showMessage('请输入投注金额', 'error');
                    return;
                }
                
                this.socket.emit('joinGameRoom', {
                    roomId,
                    userId: user.id,
                    betAmount
                });
            },
            
            // 获取游戏房间列表
            getGameRooms() {
                this.socket.emit('getGameRooms');
            },
            
            // 显示游戏房间列表
            showRoomsList() {
                const roomsList = document.getElementById('roomsList');
                roomsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">加载中...</div>';
                
                this.socket.emit('getGameRooms');
            },
            
            // 显示游戏房间信息
            showGameRoomInfo(gameRoom) {
                // 移除现有房间信息
                const existingInfo = document.querySelector('.room-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                // 创建房间信息显示
                const roomInfo = document.createElement('div');
                roomInfo.className = 'room-info';
                roomInfo.innerHTML = `
                    <h3>房间信息</h3>
                    <p>房间ID: ${gameRoom.id}</p>
                    <p>房间号: ${gameRoom.roomId}</p>
                    <p>投注金额: ${gameRoom.betAmount}</p>
                    <p>玩家数量: ${gameRoom.players.length}/${gameRoom.maxPlayers}</p>
                    <p>状态: ${gameRoom.status}</p>
                    <p>主持人: ${gameRoom.players.find(p => p.isHost)?.username || '无'}</p>
                    <div class="room-players">
                        ${gameRoom.players.map(player => `
                            <div class="room-player ${player.isHost ? 'room-player-host' : ''}">
                                <span class="room-player-name">${player.username}</span>
                                <span class="room-player-bet">💰 ${player.betAmount}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="room-actions">
                        ${gameRoom.players.find(p => p.isHost && p.userId === JSON.parse(localStorage.getItem('currentUser')).id) ? 
                            '<button class="room-item-action" onclick="GrandmaGame.startMultiplayerGame()">开始游戏</button>' : 
                            '<button class="room-item-action secondary" onclick="GrandmaGame.leaveGameRoom()">离开房间</button>'
                        }
                    </div>
                `;
                
                document.body.appendChild(roomInfo);
            },
            
            // 开始多人游戏
            startMultiplayerGame() {
                if (!this.gameState.currentGameRoom) {
                    this.showMessage('请先加入房间', 'error');
                    return;
                }
                
                this.socket.emit('startGame', this.gameState.currentGameRoom);
            },
            
            // 离开游戏房间
            leaveGameRoom() {
                if (!this.gameState.currentGameRoom) {
                    this.showMessage('您当前不在房间中', 'info');
                    return;
                }
                
                this.socket.emit('leaveGameRoom');
                
                // 移除房间信息显示
                const roomInfo = document.querySelector('.room-info');
                if (roomInfo) {
                    roomInfo.remove();
                }
                
                this.gameState.currentGameRoom = null;
                this.gameState.isHost = false;
            },
            
            // 更新危险房间显示
            updateDangerRooms(dangerRooms) {
                this.gameState.rooms.forEach(room => {
                    const roomElement = document.getElementById(`room-${room.id}`);
                    roomElement.classList.remove('danger', 'safe');
                    
                    if (dangerRooms.includes(room.id)) {
                        roomElement.classList.add('danger');
                        room.danger = true;
                    } else {
                        roomElement.classList.add('safe');
                        room.danger = false;
                    }
                });
            },
            
            // 显示游戏结果
            showGameResults(results) {
                const resultsSection = document.getElementById('gameResults');
                const resultsList = document.getElementById('resultsList');
                
                resultsSection.style.display = 'block';
                
                resultsList.innerHTML = results.map(result => `
                    <div class="result-item ${result.result}">
                        <div class="result-player">${result.username}</div>
                        <div class="result-status ${result.result}">${result.result === 'win' ? '获胜' : '失败'}</div>
                        <div class="result-amount">${result.winAmount > 0 ? '+' + result.winAmount : '+' + result.canesGained + '拐杖'}</div>
                    </div>
                `).join('');
                
                // 5秒后隐藏
                setTimeout(() => {
                    resultsSection.style.display = 'none';
                }, 5000);
            },
            
            // 更新排行榜显示
            updateLeaderboardDisplay(leaderboard) {
                const leaderboardElement = document.getElementById('leaderboardList');
                if (!leaderboardElement) return;
                
                leaderboardElement.innerHTML = leaderboard.map(player => `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">${player.rank}</div>
                        <div class="leaderboard-name">${player.username}</div>
                        <div class="leaderboard-value">💰 ${player.points}</div>
                    </div>
                `).join('');
            },
            
            // 显示房间列表
            displayGameRooms(rooms) {
                const roomsList = document.getElementById('roomsList');
                
                if (rooms.length === 0) {
                    roomsList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">暂无可用房间</div>';
                    return;
                }
                
                roomsList.innerHTML = rooms.map(room => `
                    <div class="room-item" data-room-id="${room.id}">
                        <h4>房间 ${room.roomId}</h4>
                        <p>主持人: ${room.players.find(p => p.isHost)?.username || '无'}</p>
                        <p>投注: ${room.betAmount}</p>
                        <p>玩家: ${room.players.length}/${room.maxPlayers}</p>
                        <p>状态: ${room.status}</p>
                        <button class="room-item-action" onclick="GrandmaGame.joinGameRoom('${room.id}')">加入房间</button>
                    </div>
                `).join('');
            },
            
            // 发送聊天消息
            sendMessage() {
                const chatInput = document.getElementById('chatInput');
                const message = chatInput.value.trim();
                
                if (!message) {
                    this.showMessage('请输入消息内容', 'error');
                    return;
                }
                
                const user = JSON.parse(localStorage.getItem('currentUser'));
                
                this.socket.emit('sendMessage', {
                    userId: user.id,
                    message: message,
                    roomId: this.gameState.currentGameRoom
                });
                
                chatInput.value = '';
            },
            
            // 显示聊天消息
            displayChatMessage(message) {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message';
                messageElement.innerHTML = `
                    <div class="chat-message-avatar">👤</div>
                    <div class="chat-message-content">
                        <div class="chat-message-header">
                            <span class="chat-message-username">${message.username}:</span>
                            <span class="chat-message-time">${new Date(message.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="chat-message-text">${message.message}</div>
                    </div>
                `;
                
                chatContainer.appendChild(messageElement);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            },
            
            // 显示最新背包系统
            showBackpack() {
                // 移除现有背包页面
                const existingBackpack = document.querySelector('.backpack-overlay');
                if (existingBackpack) {
                    existingBackpack.remove();
                }
                
                // 创建背包页面容器
                const backpackOverlay = document.createElement('div');
                backpackOverlay.className = 'backpack-overlay';
                
                // 创建背包页面
                const backpackPage = document.createElement('div');
                backpackPage.className = 'backpack-page';
                
                // 获取分类物品
                const categorizedItems = this.getCategorizedItems();
                
                backpackPage.innerHTML = `
                    <div class="backpack-header">
                        <div class="backpack-title">
                            <span>🎒</span>
                            <span>我的背包</span>
                        </div>
                        <button class="backpack-close" onclick="GrandmaGame.closeBackpack()">✕</button>
                    </div>
                    
                    <div class="backpack-stats">
                        <div class="backpack-stat">
                            <div class="backpack-stat-label">容量</div>
                            <div class="backpack-stat-value">${this.gameState.backpack.items.length}/${this.gameState.backpack.capacity}</div>
                        </div>
                        <div class="backpack-stat">
                            <div class="backpack-stat-label">总价值</div>
                            <div class="backpack-stat-value">💰 ${this.calculateBackpackValue()}</div>
                        </div>
                        <div class="backpack-stat">
                            <div class="backpack-stat-label">拐杖</div>
                            <div class="backpack-stat-value">🦯 ${this.gameState.userCanes}</div>
                        </div>
                    </div>
                    
                    <div class="backpack-categories">
                        ${this.gameState.backpack.categories.map(category => `
                            <div class="backpack-category ${this.gameState.backpack.selectedCategory === category ? 'active' : ''}" 
                                 onclick="GrandmaGame.filterBackpackCategory('${category}')">
                                ${this.getCategoryName(category)}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="backpack-items">
                        ${categorizedItems.map(item => `
                            <div class="backpack-item ${item.selected ? 'selected' : ''}" onclick="GrandmaGame.selectBackpackItem('${item.id}')">
                                <div class="backpack-item-icon">
                                    ${item.icon}
                                    ${item.rarity !== 'common' ? `<div class="backpack-item-rarity ${item.rarity}">${this.getRarityName(item.rarity)}</div>` : ''}
                                </div>
                                <div class="backpack-item-name">${item.name}</div>
                                <div class="backpack-item-count">×${item.count}</div>
                                <div class="backpack-item-desc">${item.description}</div>
                                ${item.stats ? `
                                    <div class="backpack-item-stats">${item.stats}</div>
                                ` : ''}
                                <div class="backpack-item-actions">
                                    ${item.usable ? `
                                        <button class="backpack-item-action" onclick="GrandmaGame.useBackpackItem('${item.id}'); GrandmaGame.closeBackpack();">
                                            使用物品
                                        </button>
                                    ` : ''}
                                    <button class="backpack-item-action" onclick="GrandmaGame.viewBackpackItem('${item.id}'); GrandmaGame.closeBackpack();">
                                        查看详情
                                    </button>
                                    ${item.sellable ? `
                                        <button class="backpack-item-action sell" onclick="GrandmaGame.sellBackpackItem('${item.id}'); GrandmaGame.closeBackpack();">
                                            出售物品
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="backpack-footer">
                        <button class="backpack-item-action" onclick="GrandmaGame.sortBackpack(); GrandmaGame.closeBackpack();">
                            <i class="fas fa-sort"></i>
                            排序
                        </button>
                        <button class="backpack-item-action" onclick="GrandmaGame.openBackpackShop(); GrandmaGame.closeBackpack();">
                            <i class="fas fa-shopping-cart"></i>
                            商店
                        </button>
                    </div>
                `;
                
                backpackOverlay.appendChild(backpackPage);
                document.body.appendChild(backpackOverlay);
            },
            
            // 获取分类物品
            getCategorizedItems() {
                const selectedCategory = this.gameState.backpack.selectedCategory;
                
                if (selectedCategory === 'all') {
                    return this.gameState.backpack.items;
                }
                
                return this.gameState.backpack.items.filter(item => 
                    item.category === selectedCategory
                );
            },
            
            // 获取分类名称
            getCategoryName(category) {
                const names = {
                    'all': '全部',
                    'consumable': '消耗品',
                    'equipment': '装备',
                    'special': '特殊',
                    'currency': '货币'
                };
                return names[category] || category;
            },
            
            // 获取稀有度名称
            getRarityName(rarity) {
                const names = {
                    'common': '普通',
                    'rare': '稀有',
                    'epic': '史诗',
                    'legendary': '传说'
                };
                return names[rarity] || rarity;
            },
            
            // 筛选背包分类
            filterBackpackCategory(category) {
                this.gameState.backpack.selectedCategory = category;
                this.showBackpack();
            },
            
            // 选择背包物品
            selectBackpackItem(itemId) {
                const item = this.gameState.backpack.items.find(item => item.id === itemId);
                
                if (!item) return;
                
                // 切换选中状态
                item.selected = !item.selected;
                
                // 如果是消耗品，使用物品
                if (item.selected && item.usable && item.category === 'consumable') {
                    this.useBackpackItem(itemId);
                }
                
                this.showBackpack();
            },
            
            // 使用背包物品
            useBackpackItem(itemId) {
                const item = this.gameState.backpack.items.find(item => item.id === itemId);
                
                if (!item || item.count <= 0) {
                    this.showMessage('物品数量不足', 'error');
                    return;
                }
                
                // 根据物品类型执行不同效果
                switch (item.id) {
                    case 'cane':
                        // 使用拐杖 - 免费一次被抓
                        this.gameState.hasProtection = true;
                        item.count--;
                        this.showMessage('拐杖已激活，下次被抓将免受损失', 'success');
                        break;
                        
                    case 'protection':
                        // 使用免伤卡
                        this.gameState.hasProtection = true;
                        item.count--;
                        this.showMessage('免伤卡已激活，下次被抓将免受损失', 'success');
                        break;
                        
                    case 'lucky_charm':
                        // 使用幸运符
                        this.gameState.luckyBonus = 0.1; // 10%存活加成
                        item.count--;
                        this.showMessage('幸运符已激活，下次存活概率增加10%', 'success');
                        break;
                        
                    case 'speed_boost':
                        // 使用加速药水
                        this.gameState.speedBonus = 5; // 5秒加速
                        item.count--;
                        this.showMessage('加速药水已激活，投注锁定时间减少5秒', 'success');
                        break;
                        
                    case 'double_reward':
                        // 使用双倍奖励卡
                        this.gameState.doubleBonus = true;
                        item.count--;
                        this.showMessage('双倍奖励卡已激活，下次获胜获得双倍奖励', 'success');
                        break;
                        
                    case 'mystery_box':
                        // 使用神秘盲盒
                        this.openMysteryBox();
                        item.count--;
                        break;
                }
                
                // 如果物品用完，从背包中移除
                if (item.count <= 0) {
                    const index = this.gameState.backpack.items.findIndex(item => item.id === itemId);
                    if (index > -1) {
                        this.gameState.backpack.items.splice(index, 1);
                    }
                }
                
                this.saveUserData();
                this.showBackpack(); // 刷新背包页面
            },
            
            // 打开神秘盲盒
            openMysteryBox() {
                const possibleItems = ['cane', 'protection', 'lucky_charm', 'speed_boost', 'double_reward'];
                const weights = [30, 10, 15, 20, 5]; // 权重
                const random = Math.random() * 100;
                let cumulative = 0;
                let selectedItem = possibleItems[0];
                
                for (let i = 0; i < possibleItems.length; i++) {
                    cumulative += weights[i];
                    if (random <= cumulative) {
                        selectedItem = possibleItems[i];
                        break;
                    }
                }
                
                const itemConfig = this.itemConfig[selectedItem];
                const newItem = {
                    ...itemConfig,
                    count: 1
                };
                
                // 添加到背包
                this.gameState.backpack.items.push(newItem);
                
                this.showMessage(`🎁 从神秘盲盒中获得了 ${newItem.name}！`, 'success');
                this.saveUserData();
                this.showBackpack();
            },
            
            // 查看背包物品详情
            viewBackpackItem(itemId) {
                const item = this.gameState.backpack.items.find(item => item.id === itemId);
                
                if (!item) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.style.zIndex = '2000';
                modal.innerHTML = `
                    <div class="item-detail-modal">
                        <div class="item-detail-header">
                            <div class="item-detail-title">${item.name}</div>
                            <button class="item-detail-close" onclick="this.closest('.modal').remove()">✕</button>
                        </div>
                        <div class="item-detail-icon">${item.icon}</div>
                        <div class="item-detail-info">
                            <div class="item-detail-row">
                                <div class="item-detail-label">稀有度:</div>
                                <div class="item-detail-value">${this.getRarityName(item.rarity)}</div>
                            </div>
                            <div class="item-detail-row">
                                <div class="item-detail-label">数量:</div>
                                <div class="item-detail-value">${item.count}</div>
                            </div>
                            <div class="item-detail-row">
                                <div class="item-detail-label">价值:</div>
                                <div class="item-detail-value">💰 ${item.value}</div>
                            </div>
                            <div class="item-detail-row">
                                <div class="item-detail-label">总价值:</div>
                                <div class="item-detail-value">💰 ${item.count * item.value}</div>
                            </div>
                            <div class="item-detail-row">
                                <div class="item-detail-label">分类:</div>
                                <div class="item-detail-value">${this.getCategoryName(item.category)}</div>
                            </div>
                            <div class="item-detail-row">
                                <div class="item-detail-label">状态:</div>
                                <div class="item-detail-value">${item.usable ? '可使用' : '不可使用'}</div>
                            </div>
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 182, 193, 0.3);">
                                <div style="color: #8B008B; margin-bottom: 10px;">${item.description}</div>
                            </div>
                        </div>
                        <div class="item-detail-actions">
                            ${item.usable ? `
                                <button class="item-detail-action" onclick="GrandmaGame.useBackpackItem('${item.id}'); this.closest('.modal').remove();">
                                    使用物品
                                </button>
                            ` : ''}
                            <button class="item-detail-action secondary" onclick="this.closest('.modal').remove();">
                                关闭
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                setTimeout(() => {
                    modal.remove();
                }, 5000);
            },
            
            // 出售背包物品
            sellBackpackItem(itemId) {
                const item = this.gameState.backpack.items.find(item => item.id === itemId);
                
                if (!item || item.count <= 0) {
                    this.showMessage('物品数量不足', 'error');
                    return;
                }
                
                const sellPrice = Math.floor(item.value * 0.5); // 50%出售价格
                const sellCount = item.count;
                const totalValue = sellPrice * sellCount;
                
                // 增加积分
                this.gameState.userPoints += totalValue;
                this.addPointsHistory('earn', totalValue, `出售${item.name}`);
                
                // 从背包中移除
                const index = this.gameState.backpack.items.findIndex(item => item.id === itemId);
                if (index > -1) {
                    this.gameState.backpack.items.splice(index, 1);
                }
                
                this.updatePointsDisplay();
                this.saveUserData();
                
                this.showMessage(`成功出售 ${sellCount}个${item.name}，获得${totalValue}积分`, 'success');
                this.showBackpack();
            },
            
            // 排序背包
            sortBackpack() {
                // 按稀有度排序
                const rarityOrder = { 'legendary': 4, 'epic': 3, 'rare': 2, 'common': 1 };
                
                this.gameState.backpack.items.sort((a, b) => {
                    const rarityA = rarityOrder[a.rarity] || 0;
                    const rarityB = rarityOrder[b.rarity] || 0;
                    
                    if (rarityA !== rarityB) {
                        return rarityB - rarityA;
                    }
                    
                    // 相同稀有度按价值排序
                    return b.value - a.value;
                });
                
                this.showBackpack();
            },
            
            // 打开背包商店
            openBackpackShop() {
                this.showMessage('背包商店功能开发中...', 'info');
            },
            
            // 关闭背包
            closeBackpack() {
                const backpackOverlay = document.querySelector('.backpack-overlay');
                if (backpackOverlay) {
                    backpackOverlay.remove();
                }
            },
            
            // 显示每日任务
            showDailyTasks() {
                // 移除现有任务页面
                const existingTasks = document.querySelector('.tasks-overlay');
                if (existingTasks) {
                    existingTasks.remove();
                }
                
                // 创建任务页面容器
                const tasksOverlay = document.createElement('div');
                tasksOverlay.className = 'tasks-overlay';
                
                // 创建任务页面
                const tasksPage = document.createElement('div');
                tasksPage.className = 'tasks-page';
                
                const task1 = this.gameState.dailyTasks.task1;
                const task2 = this.gameState.dailyTasks.task2;
                const task3 = this.gameState.dailyTasks.task3;
                
                tasksPage.innerHTML = `
                    <div class="tasks-title">📋 每日任务</div>
                    <div class="tasks-list">
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-name">任务一：勇敢的挑战者</div>
                                <div class="task-reward">💰 2.88</div>
                            </div>
                            <div class="task-desc">游玩10把游戏，单局投注不低于5积分</div>
                            <div class="task-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${(task1.completed / task1.target) * 100}%"></div>
                                </div>
                                <div class="progress-text">${task1.completed}/${task1.target}</div>
                            </div>
                            <button class="task-btn" ${task1.completed >= task1.target && !task1.claimed ? '' : 'disabled'} onclick="GrandmaGame.claimTaskReward('task1')">
                                ${task1.claimed ? '已领取' : '领取奖励'}
                            </button>
                        </div>
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-name">任务二：坚持不懈</div>
                                <div class="task-reward">🦯 10.88</div>
                            </div>
                            <div class="task-desc">游玩30把游戏，每损失100积分概率获得拐杖</div>
                            <div class="task-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${(task2.completed / task2.target) * 100}%"></div>
                                </div>
                                <div class="progress-text">${task2.completed}/${task2.target}</div>
                            </div>
                            <div class="task-desc">今日已触发: ${task3.count}/10 次</div>
                            <button class="task-btn" ${task2.completed >= task2.target && !task2.claimed ? '' : 'disabled'} onclick="GrandmaGame.claimTaskReward('task2')">
                                ${task2.claimed ? '已领取' : '领取奖励'}
                            </button>
                        </div>
                        <div class="task-item">
                            <div class="task-header">
                                <div class="task-name">任务三：幸运星</div>
                                <div class="task-reward">🎁 随机奖励</div>
                            </div>
                            <div class="task-desc">完成游戏有概率获得随机奖励，每日最多10次</div>
                            <div class="task-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${(task3.completed / task3.target) * 100}%"></div>
                                </div>
                                <div class="progress-text">${task3.completed}/${task3.target}</div>
                            </div>
                            <div class="task-desc">今日已触发: ${task3.count}/10 次</div>
                        </div>
                    </div>
                    <button class="settlement-btn" onclick="GrandmaGame.closeDailyTasks()">关闭</button>
                `;
                
                tasksOverlay.appendChild(tasksPage);
                document.body.appendChild(tasksOverlay);
            },
            
            // 关闭每日任务
            closeDailyTasks() {
                const tasksOverlay = document.querySelector('.tasks-overlay');
                if (tasksOverlay) {
                    tasksOverlay.remove();
                }
            },
            
            // 领取任务奖励
            claimTaskReward(taskId) {
                const task = this.gameState.dailyTasks[taskId];
                
                if (task.completed >= task.target && !task.claimed) {
                    task.claimed = true;
                    
                    if (taskId === 'task1') {
                        this.gameState.userPoints += 2.88;
                        this.addPointsHistory('earn', 2.88, '任务一奖励');
                        this.showMessage('成功领取任务一奖励：2.88积分', 'success');
                    } else if (taskId === 'task2') {
                        this.gameState.userCanes += 10.88;
                        this.showMessage('成功领取任务二奖励：10.88个拐杖', 'success');
                    }
                    
                    this.updatePointsDisplay();
                    this.updateUserInfo();
                    this.saveUserData();
                    this.showDailyTasks(); // 刷新任务页面
                }
            },
            
            // 更新任务进度
            updateTaskProgress(taskId, value) {
                const task = this.gameState.dailyTasks[taskId];
                
                if (taskId === 'task1') {
                    // 任务一：每玩一把游戏增加进度
                    task.completed = Math.min(task.completed + 1, task.target);
                } else if (taskId === 'task2') {
                    // 任务二：每损失100积分增加进度
                    task.completed = Math.min(task.completed + Math.floor(value / 100), task.target);
                } else if (taskId === 'task3') {
                    // 任务三：随机触发
                    if (task.count < 10 && Math.random() < 0.3) {
                        task.completed = Math.min(task.completed + 1, task.target);
                        task.count++;
                        
                        // 随机奖励
                        const rewards = [
                            { amount: 0.88, probability: 0.7 },
                            { amount: 2.88, probability: 0.2 },
                            { amount: 5.88, probability: 0.07 },
                            { amount: 18.88, probability: 0.03 }
                        ];
                        
                        let random = Math.random();
                        let cumulative = 0;
                        let rewardAmount = 0;
                        
                        for (const reward of rewards) {
                            cumulative += reward.probability;
                            if (random <= cumulative) {
                                rewardAmount = reward.amount;
                                break;
                            }
                        }
                        
                        this.gameState.userPoints += rewardAmount;
                        this.addPointsHistory('earn', rewardAmount, '任务三奖励');
                        this.updatePointsDisplay();
                        this.saveUserData();
                        
                        this.showMessage(`🎁 触发任务三奖励：${rewardAmount}积分`, 'success');
                    }
                }
                
                this.saveUserData();
            },
            
            // 显示积分明细
            showPointsDetails() {
                // 移除现有积分页面
                const existingPoints = document.querySelector('.points-overlay');
                if (existingPoints) {
                    existingPoints.remove();
                }
                
                // 创建积分页面容器
                const pointsOverlay = document.createElement('div');
                pointsOverlay.className = 'points-overlay';
                
                // 创建积分页面
                const pointsPage = document.createElement('div');
                pointsPage.className = 'points-page';
                
                // 计算盈亏
                const profit = this.gameState.totalEarned - this.gameState.totalInvested;
                
                pointsPage.innerHTML = `
                    <div class="points-title">💰 积分明细</div>
                    <div class="points-stats">
                        <div class="points-stat">
                            <div class="stat-label">总投入</div>
                            <div class="stat-value">💰 ${this.gameState.totalInvested}</div>
                        </div>
                        <div class="points-stat">
                            <div class="stat-label">总收入</div>
                            <div class="stat-value">💰 ${this.gameState.totalEarned}</div>
                        </div>
                        <div class="points-stat">
                            <div class="stat-label">盈亏</div>
                            <div class="stat-value ${profit >= 0 ? 'positive' : 'negative'}">💰 ${profit}</div>
                        </div>
                        <div class="points-stat">
                            <div class="stat-label">当前积分</div>
                            <div class="stat-value">💰 ${this.gameState.userPoints}</div>
                        </div>
                    </div>
                    <div class="points-history">
                        ${this.gameState.pointsHistory.length > 0 ? 
                            this.gameState.pointsHistory.map(record => `
                                <div class="history-item">
                                    <div class="history-desc">${record.description}</div>
                                    <div class="history-amount ${record.type === 'earn' ? 'positive' : 'negative'}">
                                        ${record.type === 'earn' ? '+' : '-'}💰 ${record.amount}
                                    </div>
                                </div>
                            `).join('') : 
                            '<div style="text-align: center; color: #666; padding: 20px;">暂无记录</div>'
                        }
                    </div>
                    <button class="settlement-btn" onclick="GrandmaGame.closePointsDetails()">关闭</button>
                `;
                
                pointsOverlay.appendChild(pointsPage);
                document.body.appendChild(pointsOverlay);
            },
            
            // 关闭积分明细
            closePointsDetails() {
                const pointsOverlay = document.querySelector('.points-overlay');
                if (pointsOverlay) {
                    pointsOverlay.remove();
                }
            },
            
            // 添加积分历史记录
            addPointsHistory(type, amount, description) {
                this.gameState.pointsHistory.unshift({
                    type,
                    amount,
                    description,
                    timestamp: new Date()
                });
                
                // 只保留最近50条记录
                if (this.gameState.pointsHistory.length > 50) {
                    this.gameState.pointsHistory.pop();
                }
                
                // 重新计算统计
                this.calculatePointsStats();
                
                this.saveUserData();
            },
            
            // 开始天气效果
            startWeatherEffect() {
                const weatherEffect = document.getElementById('weatherEffect');
                
                setInterval(() => {
                    if (Math.random() < 0.3) {
                        weatherEffect.classList.add('blood-rain');
                        setTimeout(() => {
                            weatherEffect.classList.remove('blood-rain');
                        }, 5000);
                    }
                }, 15000);
            },
            
            // 显示消息
            showMessage(text, type) {
                const existingMessage = document.querySelector('.message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                const message = document.createElement('div');
                message.className = `message ${type}`;
                message.textContent = text;
                document.body.appendChild(message);
                
                setTimeout(() => {
                    message.remove();
                }, 3000);
            }
        };
        
        // 全局函数
        window.GrandmaGame = GrandmaGame;
        
        // 全局函数
        function quickBet(amount) {
            GrandmaGame.quickBet(amount);
        }
        
        function placeBet() {
            GrandmaGame.placeBet();
        }
        
        function switchLeaderboard(type) {
            GrandmaGame.switchLeaderboard(type);
        }
        
        // 页面加载时初始化
        window.onload = function() {
            console.log('页面加载完成，开始初始化游戏');
            GrandmaGame.init();
        };
    </script>
</body>
</html>